/*
 * ooiui/static/js/views/science/plot/PlotInstrumentView.js
 * Simple List view for the selected streams
 *
 * Collection:
 *  - ooiui/static/js/models/science/StreamModel
 *  - StreamCollection subset
 */

var PlotInstrumentView = Backbone.View.extend({
  subviews: [],
  events: {
  },
  initialize: function() {
    this.initialRender();
  },
  initialRender: function() {
    //this.$el.html('<i class="fa fa-spinner fa-spin" style="margin-top:40px;margin-left:40%;font-size:90px;"> </i>');
    //this.emptyRender();
  },
  template: JST['ooiui/static/js/partials/science/plot/PlotInstruments.html'],
  render:function(){
    //base render class
    var self = this;
    this.$el.html(this.template({collection:this.collection}));
    //this.collection = selected stream collection

    // console.log('In PlotInstrumentsView.js render method');
    // console.log(this.collection);

    if (this.collection.length === 0){
      self.emptyRender();
    }else{
      this.collection.each(function(model) {
        var subview = new PlotInstrumentViewItem({
          model: model,
          collection: collection
        });
        self.$el.find('tbody.table-contents').append(subview.$el);
        self.subviews.push(subview);
      });
    }

  },
  emptyRender:function(){
    $('#instruments-table').find('table').remove();
    $('#instruments-table').find('div').remove();
    $('#instruments-table').append('<p class="initial-text"> How to plot data:</p>');
    $('#instruments-table').append('<p class="initial-text"> Step 1) Please select an Instrument from the Data Catalog below using the <i style="font-size:14px;pointer-events: none;" class="fa fa-plus-square" aria-hidden="true"></i> button.</p>');
    $('#instruments-table').append('<p class="initial-text"> Step 2) Click on a stream to plot.</p>');
    $('#instruments-table').append('<p class="initial-text"> Step 3) Click the Plotting tab above to configure and visualize your plot.</p>');
  }
});

var PlotInstrumentViewItem = Backbone.View.extend({
  className: 'plot-instrument-view-item',
  tagName:"tr",
  events: {
  },
  events:{
    "click .stream-to-plot" : "onRemoveClick"
  },
  initialize: function() {
    this.render();
  },
  template: JST['ooiui/static/js/partials/science/plot/PlotInstrumentsItem.html'],
  render:function(){
    var self = this;
    this.$el.html(this.template({model:this.model}));
  },
  onRemoveClick:function(evt){
    //console.log('evt');
    //console.log(evt);

    // Find the target's i.fa using the data-stream_uid autogenerated during construction
    var $targetButton = $('[data-stream_uid=' + $(evt.target).data('ref_des') + $(evt.target).data('stream_name') + ']');
    //console.log('targetButton');
    //console.log($targetButton);

    // Check the selected stream is not already selected
    if($targetButton.hasClass('fa-plus-square')){
      // Toggle plus to minus on button
      $targetButton.removeClass('fa-plus-square').addClass('fa-minus-square');

      // Add the selected stream to the plotting data models and enable plotting tabs
      var modelList = ooi.collections.allStreamCollection.where({'reference_designator': $(evt.target).data('ref_des'),'stream_name': $(evt.target).data('stream_name')});
      //console.log(modelList);
      if (!_.isUndefined(modelList) && modelList.length > 0) {
        $.when(ooi.collections.selectedStreamCollection.add(modelList)).done(function (ret) {
          console.log(ret);
          // $(evt.target).find('i').removeClass('fa-plus-square').addClass('fa-minus-square');

          ooi.trigger('update_catalog_list', {});
          ooi.showPlottingTabs();
        })
      }

      // Disable other streams from being plotted
      $('.stream-to-plot').not('[data-stream_name=' + $(evt.target).data('stream_name') + ']').prop('disabled', 'true');

    }else{
      // Toggle the minus to plus button
      $targetButton.removeClass('fa-minus-square').addClass('fa-plus-square');

      // Enable other streams to be plotted
      $('.stream-to-plot').removeAttr("disabled");

      // Clear the stream from plotting and hide the plotting tabs
      ooi.trigger('reset_catalog_list',{});

    }
  }
});
